<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
<script>

  window.addEventListener('load', searchData)

  function validarFormulario() {
    loadingOnOff()

    const formValues = document.getElementById('createUser');

    const form = {
      userId: document.getElementById('userId').value,
      userName: document.getElementById('userName').value,
      userLastName: document.getElementById('userLastName').value,
      userPhone: document.getElementById('userPhone').value,
      userDni: document.getElementById('userDni').value,
      userCod: document.getElementById('userCod').value,
      userReferent: document.getElementById('userReferent').value,
      userDateOfFirstContact: document.getElementById('userDateOfFirstContact').value,
      userStatusWeb: document.getElementById('userStatusWeb').value,
      userCountry: document.getElementById('userCountry').value,
      userProduct: document.getElementById('userProduct').value,
      userStatusRisk: document.getElementById('userStatusRisk').value,
    }

    console.log(form)
    const id = form.userId;

    if (id === '') {
      //Create
      google.script.run
        .withSuccessHandler(result => {
          loadingOnOff()
          searchData()
          formValues.reset();
          const createModal = bootstrap.Modal.getOrCreateInstance('#createModal');
          createModal.hide();
          handleSaveAlert()
        })
        .addUser(form);
    } else {
      google.script.run
        .withSuccessHandler(result => {
          loadingOnOff()
          searchData()
          formValues.reset()
          const createModal = bootstrap.Modal.getOrCreateInstance('#createModal');
          createModal.hide();
          handleSaveAlert()
        })
        .editUser(form)
    }
  }

  function searchData() {

    google.script.run
      .withSuccessHandler(usersData => {
        let tableBody = document.getElementById('tableBody-users');
        let template = document.getElementById('rowTemplate')
        let templateContent = template.content;

        tableBody.innerHTML = ''

        usersData.reverse().forEach(user => {
          const tr = templateContent.cloneNode(true)

          const nameCol = tr.querySelector(".template-name");
          const lastNameCol = tr.querySelector(".template-lastName");
          const countryCol = tr.querySelector(".template-country");
          const phoneCol = tr.querySelector(".template-phone");
          const dniCol = tr.querySelector(".template-dni");
          const codCol = tr.querySelector(".template-cod");
          const referenteCol = tr.querySelector(".template-referent");
          const dateOfFirstContactCol = tr.querySelector(".template-dateOfFirstContact");
          const statusWebCol = tr.querySelector(".template-statusWeb");
          const productCol = tr.querySelector(".template-product");
          const statusRiskCol = tr.querySelector(".template-statusRisk");

          const actionCol = tr.querySelector(".template-actions");
          const editButton = tr.querySelector(".button-edit");

          countryCol.textContent = user[1]
          nameCol.textContent = user[2]
          lastNameCol.textContent = user[3]
          phoneCol.textContent = user[4]
          dniCol.textContent = user[5]
          codCol.textContent = user[6]
          referenteCol.textContent = user[7]
          dateOfFirstContactCol.textContent = user[8]
          statusWebCol.textContent = user[9]
          productCol.textContent = user[10]
          statusRiskCol.textContent = user[11]

          editButton.dataset.usuarioId = user[0]

          tableBody.appendChild(tr);
        })
      })
      .readUsers()

  }

  function handleUpdateUserInfo(button) {
    const tableRow = button.parentNode.parentNode;

    const id = button.dataset.usuarioId;

    const country = tableRow.cells[0].innerHTML;
    const name = tableRow.cells[1].innerHTML;
    const lastName = tableRow.cells[2].innerHTML;
    const phone = tableRow.cells[3].innerHTML;
    const dni = tableRow.cells[4].innerHTML;
    const cod = tableRow.cells[5].innerHTML;
    const referent = tableRow.cells[6].innerHTML;
    const dateOfFirstContact = tableRow.cells[7].innerHTML;
    const statusWeb = tableRow.cells[8].innerHTML;
    const product = tableRow.cells[9].innerHTML;
    const statusRisk = tableRow.cells[10].innerHTML;

    const createModal = bootstrap.Modal.getOrCreateInstance('#createModal');
    createModal.show()

    document.getElementById('userId').value = id;
    document.getElementById('userName').value = name;
    document.getElementById('userLastName').value = lastName;
    document.getElementById('userPhone').value = phone;
    document.getElementById('userDni').value = dni;
    document.getElementById('userCod').value = cod;
    document.getElementById('userReferent').value = referent;
    document.getElementById('userDateOfFirstContact').value = dateOfFirstContact;
    document.getElementById('userStatusWeb').value = statusWeb;
    document.getElementById('userCountry').value = country;
    document.getElementById('userProduct').value = product;
    document.getElementById('userStatusRisk').value = statusRisk;

    getDataComentCalls(phone)

  }

  function handleSaveChanges() {

    const phone = document.getElementById('userPhone')
    const country = document.getElementById('userCountry')

    let passInputValidation = validatePhoneNumber(phone.value) && country.value.length > 0

    if (passInputValidation) {
      validarFormulario()
    }
  }

  function handleShowModalUser() {
    document.getElementById('userId').value = '';
    document.getElementById('userName').value = '';
    document.getElementById('userLastName').value = '';
    document.getElementById('userPhone').value = '';
    document.getElementById('userDni').value = '';
    document.getElementById('userCod').value = '';
    document.getElementById('userReferent').value = '';
    document.getElementById('userStatusWeb').value = '';
    document.getElementById('userCountry').value = '';
    document.getElementById('userProduct').value = '';
    document.getElementById('userStatusRisk').value = '';

  }

  function validatePhoneNumber(phoneNumber) {

    let phoneNumberTrim = phoneNumber.trim()

    // Check if the phone number is nine digits long.
    if (phoneNumberTrim.length < 9 || phoneNumberTrim.length > 10) {
      return false;
    }

    // Check if the phone number only contains digits.
    for (var i = 0; i < phoneNumberTrim.length; i++) {
      if (phoneNumberTrim.charAt(i) !== "0" && phoneNumberTrim.charAt(i) !== "1" && phoneNumberTrim.charAt(i) !== "2" && phoneNumberTrim.charAt(i) !== "3" && phoneNumberTrim.charAt(i) !== "4" && phoneNumberTrim.charAt(i) !== "5" && phoneNumberTrim.charAt(i) !== "6" && phoneNumberTrim.charAt(i) !== "7" && phoneNumberTrim.charAt(i) !== "8" && phoneNumberTrim.charAt(i) !== "9") {
        return false;
      }
    }
    // The phone number is valid.
    return true;
  }

  function loadingOnOff() {
    document.querySelector('#createUserOBF').classList.toggle("d-none")
    document.querySelector('#loadingButton').classList.toggle("d-none")
  }

  function handleSaveAlert() {
    const alertPlaceholder = document.getElementById('liveAlertPlaceholder')
    const appendAlert = (message, type) => {
      const wrapper = document.createElement('div')
      wrapper.innerHTML = [
        `<div class="alert alert-${type} alert-dismissible" role="alert">`,
        `   <div>${message}</div>`,
        '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
        '</div>'
      ].join('')

      alertPlaceholder.append(wrapper)
    }

    const alertTrigger = document.getElementById('createUserOBF')
    if (alertTrigger) {
      appendAlert('Usuario creado exitosamente!', 'success')

    }
  }

  function getDataComentCalls(target) {
    google.script.run
      .withSuccessHandler(comentsCalls => {
        let sortComentsCalls = comentsCalls
          .filter(comentCall => comentCall[2] === target)
        console.log(sortComentsCalls)
      })
      .readComentsCall()
  }

</script>